utils = require 'utils'
md = require('node-markdown').Markdown
g = require './../global'

pages =
  show: (req, res) ->
    g.storage.data.pages.find
      title: {eq: req.params.title}
      (found) ->
        if found
          res.render 'page', {title: found.title, content: md found.content}
        else
          res.redirect '/404'
  showAll: (req, res) ->
    pages = g.storage.data.pages.all()
    res.render 'pages', {title: 'Pages', pages: pages}
  editForm: (req, res) ->
    unless g.storage.data.pages[req.params.id]
      return res.redirect '/404'

    page = g.storage.data.pages[req.params.id]
    res.render(
      'pageEditForm'
      {
        id: req.params.id
        title: page.title
        content: page.content
      }
    )
  edit: (req, res) ->
    unless g.storage.data.pages[req.params.id]
      return res.redirect '/404'

    g.storage.data.pages[req.params.id].content = req.body.content
    res.info 'Changes applied!'
  remove: (req, res) ->
    unless g.storage.data.pages[req.params.id]
      return res.redirect '/404'

    delete g.storage.data.pages[req.params.id]
    res.info 'Page successfully removed!'
  createForm: (req, res) ->
    res.render 'pageCreateForm', {title: 'New Page'}
  create: (req, res) ->
    if utils.empty req.body.title
      return res.error 'Please specify a valid title!'
    if utils.empty req.body.content
      return res.error 'Please add some content to your page!'

    g.storage.data.pages.find
      title: {eq: req.body.title}
      (found) ->
        unless found
          g.storage.data.pages.new
            title: req.body.title
            content: req.body.content
          res.info 'Page successfully created!'
        else
          res.error 'Please choose another title, this one is already in use!'

module.exports = pages