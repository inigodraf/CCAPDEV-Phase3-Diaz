utils = require 'utils'
g = require './../global'

users =
  showAll: (req, res) ->
    users = g.storage.data.users.all()
    res.render 'users', {title: 'Users', users: users}
  createForm: (req, res) ->
    res.render 'userCreateForm', {title: 'New User'}
  create: (req, res) ->
    if utils.empty req.body.username
      return res.error 'Please choose a valid username!'
    if utils.empty req.body.password
      return res.error 'Please choose a valid password!'
    console.log utils.isNumber(req.body.lvl)
    unless utils.isNumber req.body.lvl
      return res.error 'Make sure the access lvl is actually a number!'

    g.storage.data.users.find
      username: {eq: req.body.username}
      (found) ->
        unless found
          g.storage.data.users.new
            username: req.body.username
            password: utils.hash(req.body.password)
            lvl: req.body.lvl
          res.info 'User successfully created!'
        else
          res.error 'Please choose another username, the desired one is already taken!'
  show: (req, res) ->
    id = req.params.id
    unless g.storage.data.users[id]
      return res.error 'User not found, please specify a valid id!'
    if g.storage.data.users[id].lvl >= req.session.login
      return res.error 'Insufficient rights!'

    user = g.storage.data.users[id]
    user.id = id

    res.render 'userEditForm', {title: user.username, user: user}
  edit: (req, res) ->
    id = req.params.id
    unless g.storage.data.users[id]
      return res.error 'User not found, please specify a valid id!'
    if g.storage.data.users[id].lvl >= req.session.login
      return res.error 'Insufficient rights!'
    unless utils.isNumber req.body.lvl
      return res.error 'Make sure the access lvl is actually a number!'

    user = g.storage.data.users[id]
    user.lvl = req.body.lvl
    user.password = utils.hash req.body.password unless utils.empty req.body.password
    res.info 'User data successfully changed!'
  remove: (req, res) ->
    id = req.params.id
    unless g.storage.data.users[id]
      return res.error 'User not found, please specify a valid id!'
    if g.storage.data.users[id].lvl >= req.session.login
      return res.error 'Insufficient rights!'

    delete g.storage.data.users[id]
    res.info 'User successfully removed!'

module.exports = users