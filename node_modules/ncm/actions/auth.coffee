utils = require 'utils'
g = require './../global'

auth =
  loginForm: (req, res) ->
    res.render 'loginForm', {title: 'Login'}
  login: (req, res) ->
    g.storage.data.users.find
      username: {eq: req.body.username}
      password: {eq: utils.hash(req.body.password)}
      (found) ->
        if found
          req.session.login = found.lvl
          res.info 'Login successful!'
        else
          res.error 'Please verify whether your login data are correct! Make sure cookies are enabled!'
  logout: (req, res) ->
    delete req.session.login
    res.info 'You have been logged out successfully!'
  loggedIn: (lvl) ->
    (req, res, next) ->
      if req.session?.login >= lvl
        next()
      else
        res.error 'Please make sure you are logged in and have sufficient rights to use the desired function!'
  notLoggedIn: (req, res, next) ->
    if req.session?.login
      res.error 'You are already logged in!'
    else
      next()

module.exports = auth